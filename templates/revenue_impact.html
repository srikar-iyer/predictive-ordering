{% extends 'base.html' %}

{% block title %}Revenue Impact Analysis - Predictive Ordering System{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Revenue Impact Analysis</h1>
    
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">Revenue Impact Overview</h5>
                </div>
                <div class="card-body">
                    <p>Revenue impact analysis helps visualize how pricing changes affect your bottom line across multiple products. This analysis combines price elasticity data with forecast models to project revenue changes over time.</p>
                    
                    <h6>Key Features:</h6>
                    <ul>
                        <li>Waterfall charts showing profit changes by product</li>
                        <li>Time-based analysis showing impact over different periods</li>
                        <li>Price optimization suggestions based on elasticity data</li>
                        <li>Comparative analysis of different pricing strategies</li>
                    </ul>
                    
                    <p class="text-muted small">Use the time period toggle to view short-term vs. long-term revenue impacts of price changes.</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Analysis Settings</h5>
                </div>
                <div class="card-body">
                    <form id="revenue-form">
                        <div class="mb-3">
                            <label for="store-id" class="form-label">Store ID</label>
                            <input type="text" class="form-control" id="store-id" value="104.0">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check form-switch d-flex align-items-center">
                                <input class="form-check-input" type="checkbox" id="toggle-product-name" checked>
                                <label class="form-check-label ms-2" for="toggle-product-name">Show Product Names</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="time-period" class="form-label">Time Period</label>
                            <select class="form-select" id="time-period">
                                <option value="7">7 Days</option>
                                <option value="30" selected>30 Days</option>
                                <option value="90">90 Days</option>
                                <option value="180">180 Days</option>
                                <option value="365">365 Days</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="date-range" class="form-label">Custom Date Range</label>
                            <div class="input-group">
                                <input type="date" class="form-control" id="start-date">
                                <span class="input-group-text">to</span>
                                <input type="date" class="form-control" id="end-date">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Price Strategy</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="price-strategy" id="optimal-strategy" value="optimal" checked>
                                <label class="form-check-label" for="optimal-strategy">
                                    Optimal (Profit Maximizing)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="price-strategy" id="competitive-strategy" value="competitive">
                                <label class="form-check-label" for="competitive-strategy">
                                    Competitive (Market Share)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="price-strategy" id="balanced-strategy" value="balanced">
                                <label class="form-check-label" for="balanced-strategy">
                                    Balanced (Volume and Profit)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-warning">Update Analysis</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Profit Impact Waterfall</h5>
                </div>
                <div class="card-body">
                    <div id="profit-impact-chart" style="height: 600px; width: 100%; overflow-x: auto;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Revenue Over Time Comparison</h5>
                </div>
                <div class="card-body">
                    <div id="revenue-time-chart" style="height: 400px; width: 100%; overflow-x: auto;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">Key Revenue Metrics</h5>
                </div>
                <div class="card-body">
                    <div id="revenue-metrics">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Current Revenue</h6>
                                        <h3 class="mb-0">$<span id="current-revenue">14,850</span></h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Projected Revenue</h6>
                                        <h3 class="mb-0">$<span id="projected-revenue">16,320</span></h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Revenue Change</h6>
                                        <h3 class="mb-0 text-success">+<span id="revenue-change">9.9</span>%</h3>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-muted">Profit Margin</h6>
                                        <h3 class="mb-0"><span id="profit-margin">34.2</span>%</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/date-range-utility.js') }}"></script>
<script>
    // Function to fetch and display profit impact waterfall
    function loadProfitImpact() {
        // Get form values
        const storeId = document.getElementById('store-id').value;
        const timePeriod = document.getElementById('time-period').value;
        const priceStrategy = document.querySelector('input[name="price-strategy"]:checked').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const showProductName = document.getElementById('toggle-product-name').checked;
        
        // Build query string
        let queryParams = [];
        if (storeId) queryParams.push(`store_id=${storeId}`);
        if (timePeriod) queryParams.push(`period=${timePeriod}`);
        if (priceStrategy) queryParams.push(`strategy=${priceStrategy}`);
        if (startDate) queryParams.push(`start_date=${startDate}`);
        if (endDate) queryParams.push(`end_date=${endDate}`);
        queryParams.push(`show_product_name=${showProductName}`);
        const queryString = queryParams.length > 0 ? `?${queryParams.join('&')}` : '';
        
        fetch(`/api/profit-impact${queryString}`)
            .then(response => response.json())
            .then(data => {
                const chartData = JSON.parse(data);
                // Make chart wider
                chartData.layout.width = null;
                chartData.layout.autosize = true;
                chartData.layout.margin = {l: 60, r: 30, b: 60, t: 80, pad: 4};
                Plotly.newPlot('profit-impact-chart', chartData.data, chartData.layout);
            })
            .catch(error => {
                console.error('Error loading profit impact:', error);
                document.getElementById('profit-impact-chart').innerHTML = 
                    `<div class="alert alert-danger">Error loading profit impact: ${error.message}</div>`;
            });
    }
    
    // Function to simulate revenue over time comparison
    function loadRevenueTimeChart() {
        // In a real implementation, this would fetch data from an API endpoint
        // Here, we'll simulate the data based on the selected time period and strategy
        
        const timePeriod = parseInt(document.getElementById('time-period').value);
        const priceStrategy = document.querySelector('input[name="price-strategy"]:checked').value;
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        // If custom date range is provided, use that instead of time period
        const useCustomDateRange = startDate && endDate;
        
        // Generate dates
        const dates = [];
        const currentDate = new Date();
        for (let i = 0; i < timePeriod; i++) {
            const date = new Date();
            date.setDate(currentDate.getDate() + i);
            dates.push(date.toISOString().split('T')[0]);
        }
        
        // Generate revenue values based on strategy
        const currentRevenue = [];
        const projectedRevenue = [];
        
        // Baseline daily revenue
        const baselineRevenue = 500;
        
        // Strategy factors
        const strategyFactors = {
            optimal: {growth: 1.2, volatility: 0.1},
            competitive: {growth: 1.4, volatility: 0.15},
            balanced: {growth: 1.3, volatility: 0.08}
        };
        
        const factor = strategyFactors[priceStrategy];
        
        // Generate revenue data
        for (let i = 0; i < timePeriod; i++) {
            // Current revenue with some weekly pattern
            const dayFactor = 1 + 0.2 * Math.sin(i * Math.PI / 7);
            const current = baselineRevenue * dayFactor * (1 + 0.05 * Math.random());
            currentRevenue.push(current);
            
            // Projected revenue with growth based on strategy
            const growthProgress = i / timePeriod; // Increases over time
            const growth = 1 + (factor.growth - 1) * growthProgress;
            const volatility = factor.volatility * Math.random() - factor.volatility/2;
            const projected = current * growth * (1 + volatility);
            projectedRevenue.push(projected);
        }
        
        // Create the chart
        const trace1 = {
            x: dates,
            y: currentRevenue,
            type: 'scatter',
            mode: 'lines',
            name: 'Current Revenue',
            line: {color: '#6c757d'}
        };
        
        const trace2 = {
            x: dates,
            y: projectedRevenue,
            type: 'scatter',
            mode: 'lines',
            name: 'Projected Revenue',
            line: {color: '#ffc107'}
        };
        
        const layout = {
            margin: {t: 30, b: 50, l: 60, r: 30},
            xaxis: {title: 'Date'},
            yaxis: {title: 'Daily Revenue ($)'},
            legend: {orientation: 'h', y: 1.1},
            width: null,
            autosize: true
        };
        
        Plotly.newPlot('revenue-time-chart', [trace1, trace2], layout);
        
        // Update metrics
        updateRevenueMetrics(currentRevenue, projectedRevenue, priceStrategy);
    }
    
    // Function to update revenue metrics
    function updateRevenueMetrics(currentRevenue, projectedRevenue, strategy) {
        // Calculate total revenue
        const totalCurrent = currentRevenue.reduce((sum, val) => sum + val, 0);
        
        // Calculate total projected revenue with some variation based on strategy
        const strategyFactors = {
            optimal: 1.10,
            competitive: 1.15,
            balanced: 1.12
        };
        
        const totalProjected = projectedRevenue.reduce((sum, val) => sum + val, 0);
        
        // Calculate change percentage
        const changePercent = ((totalProjected - totalCurrent) / totalCurrent * 100);
        
        // Calculate profit margin based on strategy
        const marginFactors = {
            optimal: 34.2,
            competitive: 29.8,
            balanced: 32.5
        };
        
        // Update the metrics in the UI
        document.getElementById('current-revenue').textContent = totalCurrent.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('projected-revenue').textContent = totalProjected.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        document.getElementById('revenue-change').textContent = changePercent.toFixed(1);
        document.getElementById('profit-margin').textContent = marginFactors[strategy];
        
        // Change the color of revenue change based on value
        if (changePercent > 0) {
            document.getElementById('revenue-change').parentNode.className = "mb-0 text-success";
            document.getElementById('revenue-change').parentNode.innerHTML = "+" + changePercent.toFixed(1) + "%";
        } else {
            document.getElementById('revenue-change').parentNode.className = "mb-0 text-danger";
            document.getElementById('revenue-change').parentNode.innerHTML = changePercent.toFixed(1) + "%";
        }
    }
    
    // Load all charts on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize date pickers using the utility
        initDateRangePickers();
        
        loadProfitImpact();
        loadRevenueTimeChart();
        
        // Handle form submission
        document.getElementById('revenue-form').addEventListener('submit', function(e) {
            e.preventDefault();
            loadProfitImpact();
            loadRevenueTimeChart();
        });
        
        // Handle time period changes for more responsive UI
        document.getElementById('time-period').addEventListener('change', function() {
            loadRevenueTimeChart();
        });
        
        // Handle date range changes
        document.getElementById('start-date').addEventListener('change', function() {
            loadRevenueTimeChart();
            loadProfitImpact();
        });
        
        document.getElementById('end-date').addEventListener('change', function() {
            loadRevenueTimeChart();
            loadProfitImpact();
        });
        
        // Handle price strategy changes for more responsive UI
        document.querySelectorAll('input[name="price-strategy"]').forEach(radio => {
            radio.addEventListener('change', function() {
                loadRevenueTimeChart();
            });
        });
        
        // Handle product name toggle
        document.getElementById('toggle-product-name').addEventListener('change', function() {
            loadProfitImpact();
        });
    });
</script>
{% endblock %}